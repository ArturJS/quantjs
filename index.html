<!DOCTYPE html>
<html><head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta charset="UTF-8">
    <title>Generate Circuits</title>

    <link rel="stylesheet" href="styles.css">

    <script src="libs/Chart.min.js"></script>
    <script src="gui/generatorparameters.js"></script>
    <script src="gui/echocommands.js"></script>
    <script src="toolparameters.js"></script>

    <script src="circuits/wireutils.js"></script>
    <script src="circuits/placegate.js"></script>
    <script src="circuits/template.js"></script>
    <script src="circuits/gatestring.js"></script>
    <script src="circuits/tgatesprocess.js"></script>
    <script src="circuits/chemcircuit.js"></script>
    <script src="circuits/addercircuit.js"></script>
    <script src="circuits/qrom.js"></script>

    <script src="tabs.js"></script>
    <script src="astateconsume.js"></script>
    <script src="reorderwires.js"></script>
    <script src="binarytools.js"></script>
    <script src="quirklink.js"></script>
    <script src="gatesslider.js"></script>
    <script src="circuitanalysis.js"></script>

<script>

//TODO: fa sa dispara asta care arata global
var currentGenerator = null;
var echoCommands = new EchoCommands(toolParameters);

function otherCircuitSelected()
{
    //reset number of qubits
    //because some circuits exponentiate this number
    //document.getElementById("nrq").value = "2";

    currentGenerator = null;

    pressGenerate();
}

function pressGenerate()
{
    var genParam = new GeneratorParameters();

    readToolParameters();

    echoCommands.echo(undefined, "stats");
    echoCommands.echo("computing...", "stats");

    if (currentGenerator == null) {

        switch (toolParameters.circuitGenerator) {
            case "majorana":
                //generateMajoranaCircuit();
//            currentGenerator = new QROMGenerator();
                break;
            case "qrom":
//            generateQROMCircuit();
//            generateQROM2Circuit();
                currentGenerator = new QROMGenerator();
                break;
            case "adder":
                currentGenerator = new AdderGenerator();
                break;
        }

        //write the html for the parameters
        document.getElementById("paramsDiv").innerHTML = genParam.generateHTML(currentGenerator.getParameters());
    }

    var paramValues = genParam.readHTMLValues(currentGenerator.getParameters());
    var gateList = currentGenerator.generateCircuit(paramValues, toolParameters);

    //mai exista un resetdata in astatesconsume
    //resetAnalysisData();
    var ngatelist = [];
    if(toolParameters.oneTGatePerTimestep)
    {
        ngatelist = oneTGatePerTimeStep(gateList);
    }
    else
    {
        ngatelist = gateList;
    }

    computeFirstWireUsage(ngatelist);

    var schedlist = arrangeDecomposedCircuit(ngatelist);

    if(toolParameters.distillAndConsumeTStates)
    {
        // make a first analysis to know how many T states need to be distilled
        var nrTGates = analyseCircuit(schedlist, 0/*no look ahead*/).nrTGates;
        schedlist = scheduleGateList(schedlist, nrTGates);
    }

    //unrolled the single qubit gates
    echoCommands.clear("circuitnew");
    for(var y=0; y<schedlist.length; y++)
    {
        echoCommands.echo(schedlist[y], "circuitnew");
    }

    /*
     analyse the circuit and plot the data resulting from the analysis
     */
    var analysisData = analyseCircuit(schedlist, toolParameters.lookAhead);

    if(!toolParameters.noVisualisation) {
        var obj = constructQuirkLink(schedlist, analysisData);

        echoCommands.clear("quirkLink");
        echoCommands.echo(obj.link, "quirkLink");

        document.getElementById("quirkiframe").src = obj.link;
    }
    var distillationDepth = (analysisData.nrTGates * toolParameters.distillationLength);

    var localNrVars = Number(gateList[0].split(" ")[1]);
    echoCommands.clear("stats");
    echoCommands.echo("number wires " + localNrVars, "stats");
    echoCommands.echo("current gate list length " + (gateList.length - 3), "stats");
    echoCommands.echo("current circuit depth " + analysisData.timesteps, "stats");
    echoCommands.echo("nr T gates "  + analysisData.nrTGates, "stats");
    echoCommands.echo("single distillation depth " + toolParameters.distillationLength, "stats");
    echoCommands.echo("total T distillations depth " + distillationDepth, "stats");

    if(toolParameters.distillAndConsumeTStates)
        estimateBoundingBox(analysisData, aStatesData);

    document.getElementById("gateslider").min = 1;
    document.getElementById("gateslider").max = gateList.length - 3;
    document.getElementById("gateslider").value = 1;

    chartAnalysisData(
        analysisData.steps,
        aStatesData.nra,//.slice(0, distillationDepth + 1),
        analysisData.counts
    );
}

function estimateBoundingBox(analysisData, aStatesData)
{
    var distillationHeight = 10;
    var distillationDepth = 6;
    var distillationWidth = 16;

    var mostAvailableDistilledAStates = aStatesData.nra.reduce(function(a, b) {
        return Math.max(a, b);
    });

    echoCommands.echo("\nEstimated bounding box (plumbing pieces):", "stats");
    var totalDepth = analysisData.timesteps * 2;
    echoCommands.echo("depth: " + totalDepth, "stats");

    var totalWidth = Math.max(mostAvailableDistilledAStates * 2 + 1/*connection around the log qubit block*/,
        distillationWidth);
    echoCommands.echo("width: " + totalWidth, "stats");

    var nrLogQubitsPerLine = Math.floor(distillationWidth / 2);
    nrLogQubitsPerLine--;//take one out because some connections use a plumbing piece

    var nrQubitLines = Math.ceil(toolParameters.nrVars / nrLogQubitsPerLine );
    var totalHeight = nrQubitLines + 2 + distillationHeight;
    echoCommands.echo("height: (" + (nrQubitLines +  2) + ") "+ totalHeight, "stats");

    var volume2 = totalHeight * totalWidth * totalDepth;
    echoCommands.echo("volume_2: " + volume2, "stats");

    var volume0 = (totalHeight - distillationHeight) * totalWidth * totalDepth;
    echoCommands.echo("volume_0: " + volume0, "stats");

    var difference = analysisData.timesteps - analysisData.nrTGates * toolParameters.distillationLength;
    var unusedDistillationBlock = 2 * difference * distillationWidth * distillationHeight;
    unusedDistillationBlock += analysisData.nrTGates * distillationWidth * distillationHeight;

    echoCommands.echo("unused distillation volume: " + unusedDistillationBlock, "stats");

    echoCommands.echo("estimated used plumbing pieces: " + (volume2 - unusedDistillationBlock), "stats");
}

/*
	... 0, 1, 2 -> ... 2, 1, 0
*/
function fromQubitNrToOrderNr(qubitnr, nrLogQubits)
{
	return nrLogQubits - 1 - qubitnr;
}

/*
	... 2, 1, 0 -> ... 0, 1, 2
*/
function fromOrderNrToQubitNr(ordernr, nrLogQubits)
{
	return nrLogQubits - 1 - ordernr;
}

</script>
</head>

<body>
<div style="width:40vw; height:1000vh; float:left;">
<div style="background-color: darkred">
    <select id="circuitgenerator" onchange="otherCircuitSelected()">
        <option value="qrom">QROM</option>
        <option value="majorana">Majorana</option>
        <!--<option value="chemistry2">Chemistry2</option>-->
        <option value="adder">Adder</option>
    </select>
    Parameters:
<br>
<!--
    Nr Log Qubits (log_2 N): <input id="nrq" value="2" size="3" type="number" min=2 onchange="pressGenerate()">
<br>
    TOTAL Q Night: <input id="totalqubitsnight" value="2" size="3" type="number" min=2">
<br>
    MU Night: <input id="munight" value="0" size="3" type="number" min=0">
<br>
-->
    <div id="paramsDiv"></div>
</div>

<div style="background-color: darkgreen">
Max avail. distilled A: <input id="nrMaxAvailable" value="0" size="3" type="number" min=0 onchange="pressGenerate()">
<br>
<input type=checkbox id=reorderwires onclick="pressGenerate()">Reorder wires based on first usage</input>
<br>
<input type=checkbox id=decomposeCheckBox onclick="pressDecompose()">Decompose to Clifford+T</input>
<br>
<input type=checkbox id=distillandconsume onclick="pressTDelay()">Distill and consume T states</input>
<br>
<input type=checkbox id=onetpertime disabled onclick="pressGenerate()">One T gate per time step</input>
<br>
<input type=checkbox id=novisual onclick="pressGenerate()">No visualisation (faster)</input>
<!--<br>
Quirk link: <a id="quirk" href="#" target="_blank">Link to Quirk (see next textbox)</a>
-->
<br>

    <!-- Tab links -->
    <div class="tab">
        <button id="defaultOpen" class="tablinks" onclick="openTab(event, 'Console')">Console</button>
        <button class="tablinks" onclick="openTab(event, 'Raw')">Raw Circ.</button>
        <button class="tablinks" onclick="openTab(event, 'Sched')">Sched. Circ.</button>
        <button class="tablinks" onclick="openTab(event, 'Link')">Link</button>
        <button class="tablinks" onclick="openTab(event, 'Memory')">Memory</button>
        <button class="tablinks" onclick="openTab(event, 'Chart')">Chart</button>
    </div>

    <!-- Tab content -->

    <div id="Console" class="tabcontent">
        <textarea id="stats" cols="60" rows="20">Statistics</textarea>
    </div>

    <div id="Raw" class="tabcontent">
        <textarea id="circuit" cols="60" rows="20" readonly>nothing generated
        </textarea>
    </div>

    <div id="Sched" class="tabcontent">
        <input id="gateslider" value="0" size="3" type="number" onchange="selectGate()"><br>
        <textarea id="circuitnew" cols="60" rows="20" readonly>nothing generated
        </textarea>
    </div>

    <div id="Link" class="tabcontent">
        Copy and paste link from Quirk to parse circuit<br>
        <textarea id="quirkLink" cols="60" rows="20">nothing copied&pasted
        </textarea>
        <br>
        <input id=btnParse type=button value="Parse" onclick="parseLink()">
        <input id=btnGIF type=button value="Get From Frame" onclick="getLinkFromIFrame()">
        <input id=btnSave type=button value="Save To Memory" onclick="saveToMemory()">
    </div>

    <div id="Memory" class="tabcontent">
        Saved Quirk Links:<br>
        <input type="button" value="Get and Save To Memory" onclick="getLinkFromIFrame(); saveToMemory()"><br>
    </div>

    <div id="Chart" class="tabcontent">
        Look ahead:<input type="number" id="lookahead" min=0 onchange="pressGenerate()" value="0">
        <br>
        <canvas id="analysisChart" width="200" height="100"></canvas>
    </div>
</div>
</div>

<script>
    function pressDecompose()
    {
        document.getElementById('btnParse').disabled = !document.getElementById('decomposeCheckBox').checked;
        pressGenerate();
    }

    function pressTDelay()
    {
        document.getElementById('onetpertime').disabled = !document.getElementById('distillandconsume').checked;
        if(document.getElementById('onetpertime').disabled)
            document.getElementById('onetpertime').checked = false;
        pressGenerate();
    }
</script>

<div id="contentframe" style="position:relative; top: 0px; left: 0px; float:right; width:57vw;height:100vh">
    <iframe id="quirkiframe" src="#" style="width:153%;height:150%;">
        <!-- the css scales to 0.65 the contents of the iframe,
        and this style is applied afterwards to set the width to 1/0.65 -->
    </iframe>
</div>

<script>
    pressGenerate();
    document.getElementById("defaultOpen").click();
</script>

</body>

</html>
